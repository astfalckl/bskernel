<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="bskernel">
<title>ML with Gaussian Likelihood • bskernel</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="ML with Gaussian Likelihood">
<meta property="og:description" content="bskernel">
<meta property="og:image" content="https://astfalckl.github.io/bskernel/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">bskernel</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/ml_gaussian.html">ML with Gaussian Likelihood</a>
    <a class="dropdown-item" href="../articles/ml_whittle.html">ML with Whittle Likelihood</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>ML with Gaussian Likelihood</h1>
            
      
      
      <div class="d-none name"><code>ml_gaussian.Rmd</code></div>
    </div>

    
    
<p>We begin by illustrating a simple example of fitting an ACF to
simulated time-series data using maximum likelihood. We simulate a
stationary Gaussian process with a known Matérn-3/2 auto-covariance
structure. Then, we fit an auto-covariance model using the
<code>bskernel</code> package, assuming linear (<span class="math inline">\(k=1\)</span>) B-spline spectral basis. The
resulting estimated ACF is compared to the true model.</p>
<p>In what follows, as we sample our data regularly, we use Toeplitz
tricks to speed matters up. Generalising to non-regular data is trivial,
it will just take longer for the optimiser to compute.</p>
<hr>
<div class="section level3">
<h3 id="simulate-a-gaussian-process-with-known-autocovariance">Simulate a Gaussian process with known autocovariance<a class="anchor" aria-label="anchor" href="#simulate-a-gaussian-process-with-known-autocovariance"></a>
</h3>
<p>Most of this is standard; we lean on the package
<code>SuperGauss</code> to efficiently sample the GP and set
<code>fft = FALSE</code> so that this sample is an exact draw.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://astfalckl.github.io/bskernel/">bskernel</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SuperGauss</span><span class="op">)</span></span>
<span></span>
<span><span class="va">matern32_cov</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">range</span>, <span class="va">sigma2</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sqrt3_d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span> <span class="op">*</span> <span class="va">d</span> <span class="op">/</span> <span class="va">range</span></span>
<span>  <span class="va">sigma2</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">sqrt3_d</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">sqrt3_d</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span>
<span><span class="va">n_knots</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="va">range</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">k</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span></span>
<span><span class="va">tau</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="va">n</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">mat32_acf</span> <span class="op">&lt;-</span> <span class="fu">matern32_cov</span><span class="op">(</span><span class="va">tau</span>, <span class="va">range</span>, sigma2 <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">SuperGauss</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SuperGauss/man/rnormtz.html" class="external-link">rnormtz</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">1</span>, <span class="va">mat32_acf</span>, fft <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<hr>
</div>
<div class="section level3">
<h3 id="estimate-the-acf-using-spline-kernels">Estimate the ACF using spline kernels<a class="anchor" aria-label="anchor" href="#estimate-the-acf-using-spline-kernels"></a>
</h3>
<p>There are a couple of things to note here. First, the data are
sampled regularly with spacing 1, so the Nyquist frequency is 0.5. We
extend the knot spacing past this as we are using linear basis. Same
with the first knot, we are creating a symmetry about 0. Next,
<code>optim_toeplitz_mle</code> is optimising over the log space of the
parameters, hence why we must exponentiate the optimiser output.
Constraining the parameters to be positive like this is a sufficient but
not necessary condition to yield a positive semi-definite estimate.
Finally, the easiest way to symmetrise the bases defined by the knots is
to just take the real values.</p>
<p>The plot of the estimated vs true ACF is given below.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">knots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.05</span>, <span class="fl">0</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="va">c_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.2</span>, <span class="fl">0.15</span>, <span class="fl">0.15</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">log_c_mle</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optim_toeplitz_mle.html">optim_toeplitz_mle</a></span><span class="op">(</span><span class="va">c_init</span>, <span class="va">knots</span>, <span class="va">k</span>, <span class="va">y</span><span class="op">)</span><span class="op">$</span><span class="va">par</span></span>
<span><span class="va">c_mle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">log_c_mle</span><span class="op">)</span></span>
<span><span class="va">acf_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reconstruct_acf.html">reconstruct_acf</a></span><span class="op">(</span><span class="va">c_mle</span>, <span class="va">knots</span>, <span class="va">k</span>, <span class="va">tau</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/complex.html" class="external-link">Re</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="ml_gaussian_files/figure-html/unnamed-chunk-5-1.png" width="480"></p>
<hr>
</div>
<div class="section level3">
<h3 id="gradient-of-the-toeplitz-representation">Gradient of the Toeplitz Representation<a class="anchor" aria-label="anchor" href="#gradient-of-the-toeplitz-representation"></a>
</h3>
<p>Warning: mathematical details not required to run the code.</p>
<p>This optimisation runs efficiently in part as we have baked in the
gradient using the Toeplitz representation of the likelihood. See
<code>compute_toeplitz_loglik_grad</code> if you want to unpack
this.</p>
<p>Let <strong><span class="math inline">\(\mathbf{y} \in
\mathbb{R}^n\)</span></strong> be a zero-mean stationary Gaussian
process with Toeplitz covariance matrix <span class="math display">\[
\Sigma = T(\boldsymbol{\rho})
\]</span> where <span class="math inline">\(T(\boldsymbol{\rho})\)</span> is a symmetric
Toeplitz matrix defined by the autocovariance vector <span class="math inline">\(\boldsymbol{\rho} = (\rho_0, \rho_1, \dots,
\rho_{n-1})\)</span>. We model each autocovariance entry as <span class="math display">\[
\rho_\tau = \sum_{i=0}^{m-1} c_i \, \phi_i(\tau)
\]</span> where</p>
<ul>
<li>
<span class="math inline">\(c_i\)</span> are coefficients,</li>
<li>
<span class="math inline">\(\phi_i(\tau)\)</span> is the inverse
Fourier transform of the <span class="math inline">\(i\)</span>-th
B-spline spectral basis function (eqn 5 of the paper).</li>
</ul>
<p>The log-likelihood is <span class="math display">\[
\ell(\mathbf{c}) = -\frac{1}{2} \left[ n \log(2\pi) + \log
|\Sigma(\mathbf{c})| + \mathbf{y}^\top \Sigma(\mathbf{c})^{-1}
\mathbf{y} \right].
\]</span></p>
<p>Apply the chain rule, <span class="math display">\[
\frac{\partial \ell}{\partial c_i} = \sum_{\tau=0}^{n-1} \frac{\partial
\ell}{\partial \rho_\tau} \cdot \frac{\partial \rho_\tau}{\partial c_i}.
\]</span> From standard matrix calculus, <span class="math display">\[
\frac{\partial \ell}{\partial \rho_\tau} = \frac{1}{2} \left[
\mathbf{y}^\top \Sigma^{-1} J^\tau \Sigma^{-1} \mathbf{y} -
\operatorname{tr}(\Sigma^{-1} J^\tau) \right]
\]</span> where <span class="math inline">\(J^\tau\)</span> is the
Toeplitz matrix with 1s on the <span class="math inline">\(\tau\)</span>-th (symmetric) off-diagonal, and 0
elsewhere. In practice, this is efficiently handled by the
<code><a href="https://rdrr.io/pkg/SuperGauss/man/NormalToeplitz.html" class="external-link">SuperGauss::NormalToeplitz</a></code> class. Since, <span class="math display">\[
\rho_\tau = \sum_i c_i \, \phi_i(\tau)
\quad \Rightarrow \quad
\frac{\partial \rho_\tau}{\partial c_i} = \phi_i(\tau),
\]</span> the Jacobian <span class="math inline">\(\partial
\boldsymbol{\rho} / \partial \mathbf{c} \in \mathbb{R}^{n \times
K}\)</span> has entries <span class="math display">\[
\left[ \frac{\partial \boldsymbol{\rho}}{\partial \mathbf{c}}
\right]_{\tau,i} = \phi_i(\tau).
\]</span></p>
<p>Putting it together, <span class="math display">\[
\nabla_{\mathbf{c}} \ell(\mathbf{c}) = \left( \frac{\partial
\ell}{\partial \boldsymbol{\rho}} \right)^\top \cdot \left(
\frac{\partial \boldsymbol{\rho}}{\partial \mathbf{c}} \right).
\]</span> In code, <code>SuperGauss</code> handles this all beautifully
with</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grad</span> <span class="op">&lt;-</span> <span class="va">nt</span><span class="op">$</span><span class="fu">grad</span><span class="op">(</span>z <span class="op">=</span> <span class="va">y</span>, dz <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span>, <span class="va">n_basis</span><span class="op">)</span>, acf <span class="op">=</span> <span class="va">rho</span>, dacf <span class="op">=</span> <span class="va">dacf</span><span class="op">)</span></span></code></pre></div>
<p>Lastly, if we optimise over the log-parameters <span class="math inline">\(\theta_i = \log c_i\)</span>, the chain rule gives
<span class="math display">\[
\frac{\partial \ell}{\partial \theta_i} = \frac{\partial \ell}{\partial
c_i} \cdot \frac{\partial c_i}{\partial \theta_i} = \frac{\partial
\ell}{\partial c_i} \cdot c_i
\]</span> and so in code,</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grad_theta</span> <span class="op">&lt;-</span> <span class="va">grad</span> <span class="op">*</span> <span class="va">c</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Lachlan Astfalck.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
